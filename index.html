<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markdown转Word工具</title>
  <style>
    body{font-family:'Microsoft YaHei',Arial,sans-serif;margin:0;padding:20px;background:#fafafa;}
    .container{display:flex;gap:20px;margin-bottom:20px;}
    .editor-box,.preview-box{flex:1;border:1px solid #e1e1e1;border-radius:12px;padding:15px;min-height:420px;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
    textarea,#output{width:100%;height:100%;min-height:420px;border:none;resize:none;outline:none;}
    #output{overflow:auto;font-family:'Times New Roman','Microsoft YaHei','SimSun',serif;}

    /* 预览区表格：实线边框 + 水平居中 */
    #output table{width:100%;border-collapse:collapse;border-spacing:0;margin:0.6em 0;}
    #output th,#output td{
      border:1px solid #000;
      padding:6px 8px;
      vertical-align:middle;
      text-align:center;
    }
    /* 预览区表格内段落：段前段后0 + 单倍行距（预览用） */
    #output th p,#output td p{
      margin:0;
      line-height:1;
    }

    .toolbar{display:flex;justify-content:center;gap:10px;margin-bottom:20px;}
    button{padding:10px 20px;background:#ff2442;color:#fff;border:none;border-radius:20px;cursor:pointer;font-weight:500;transition:all .2s;}
    button:hover{background:#e11f3a;}
  </style>
</head>
<body>
  <h1>Markdown转Word工具</h1>

  <div class="container">
    <div class="editor-box">
      <textarea id="input" placeholder="粘贴Markdown内容..."></textarea>
    </div>
    <div class="preview-box">
      <div id="output" contenteditable="false"></div>
    </div>
  </div>

  <div class="toolbar">
    <button id="btnConvert">转换（Ctrl+Enter）</button>
    <button id="btnSave">保存为Word</button>
  </div>

  <!-- 依赖：请确保同目录下有这些文件 -->
  <script src="./marked.min.js"></script>
  <script src="./FileSaver.min.js"></script>
  <script src="./html-docx.js"></script>

  <!-- JSZip：建议放本地（离线可用）；也提供 CDN 兜底 -->
  <script src="./jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    // ========== 1) 预览 ==========
    function convert(){
      const markdown = document.getElementById('input').value || '';
      const htmlContent = marked.parse(markdown);
      // ✅ 西文字体 Times New Roman；中文回退
      document.getElementById('output').innerHTML =
        `<div style="font-family:'Times New Roman','Microsoft YaHei','SimSun',serif;">${htmlContent}</div>`;
    }

    // ========== 2) 导出 HTML（给 html-docx） ==========
    // 表格内段落：显式写死为“段前0/段后0 + 单倍行距 + 居中”
    const WORD_TABLE_P_STYLE =
      "margin:0cm;" +
      "mso-para-margin-before:0pt;mso-para-margin-after:0pt;" +
      "mso-margin-top-alt:0cm;mso-margin-bottom-alt:0cm;" +
      "line-height:100%;mso-line-height-rule:auto;" +
      "text-align:center;mso-para-alignment:center;" +
      "font-family:'Times New Roman','Microsoft YaHei','SimSun',serif;";

    function normalizeTablesForWord(bodyHtml){
      const tmp = document.createElement('div');
      tmp.innerHTML = bodyHtml;

      tmp.querySelectorAll('table').forEach(tbl=>{
        // 只给单元格边框，避免 Word 出现“双线”
        tbl.style.borderCollapse = 'collapse';
        tbl.style.borderSpacing = '0';
        tbl.style.width = '100%';
      });

      tmp.querySelectorAll('table td, table th').forEach(cell=>{
        cell.style.textAlign = 'center';
        cell.style.verticalAlign = 'middle';

        // 将单元格内所有<p>归一化
        cell.querySelectorAll('p').forEach(p=>{
          const existing = p.getAttribute('style') || '';
          p.setAttribute('style', (existing ? (existing + ';') : '') + WORD_TABLE_P_STYLE);
          p.setAttribute('align','center');
        });

        // 如果没有<p>，把内容整体包到一个<p>里（Markdown 表格通常是纯文本）
        if(!cell.querySelector('p')){
          const html = (cell.innerHTML || '').trim();
          cell.innerHTML = `<p align="center" style="${WORD_TABLE_P_STYLE}">${html || '&nbsp;'}</p>`;
        }

        // 清理空白的纯文本节点（避免 Word 生成“空段落”又带默认段后）
        Array.from(cell.childNodes).forEach(n=>{
          if(n.nodeType === Node.TEXT_NODE && !n.textContent.trim()){
            cell.removeChild(n);
          }
        });
      });

      return tmp.innerHTML;
    }

    function buildDocHtml(bodyHtml){
      return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <style>
    body{font-family:'Times New Roman','SimSun','Microsoft YaHei',serif;}
    table{width:100%;border-collapse:collapse;border-spacing:0;}
    th,td{border:1pt solid #000;padding:6pt 8pt;vertical-align:middle;text-align:center;}
    /* 表格内段落：段前段后0 + 单倍行距 + 居中（HTML层） */
    th p,td p{
      margin:0cm;
      mso-para-margin-before:0pt;
      mso-para-margin-after:0pt;
      line-height:100%;
      mso-line-height-rule:auto;
      text-align:center;
      mso-para-alignment:center;
    }
  </style>
</head>
<body>${bodyHtml}</body>
</html>`;
    }

    // ========== 3) docx 补丁：100%强制“表格内段前/段后0 + 单倍行距 + 居中” ==========
    function patchStylesXml(stylesXml){
      const W_NS = 'http://schemas.openxmlformats.org/wordprocessingml/2006/main';
      const parser = new DOMParser();
      const doc = parser.parseFromString(stylesXml, 'application/xml');
      if(doc.getElementsByTagName('parsererror').length) return stylesXml;

      const ensureChild = (parent, localName) => {
        const found = Array.from(parent.childNodes).find(n => n.nodeType===1 && n.namespaceURI===W_NS && n.localName===localName);
        if(found) return found;
        const el = doc.createElementNS(W_NS, 'w:' + localName);
        parent.appendChild(el);
        return el;
      };
      const getAttr = (el, localName) => el.getAttributeNS(W_NS, localName) || el.getAttribute('w:'+localName) || el.getAttribute(localName);

      const applySpacing = (pPr) => {
        const spacing = ensureChild(pPr, 'spacing');
        spacing.setAttributeNS(W_NS, 'w:before', '0');
        spacing.setAttributeNS(W_NS, 'w:after', '0');
        spacing.setAttributeNS(W_NS, 'w:line', '240');     // 单倍行距
        spacing.setAttributeNS(W_NS, 'w:lineRule', 'auto');
      };
      const applyCenter = (pPr) => {
        const jc = ensureChild(pPr, 'jc');
        jc.setAttributeNS(W_NS, 'w:val', 'center');
      };

      // docDefaults：保证没有明确样式时也不再是 8磅/1.16
      const docDefaults = doc.getElementsByTagNameNS(W_NS, 'docDefaults')[0];
      if(docDefaults){
        const pPrDefault = ensureChild(docDefaults, 'pPrDefault');
        const pPr = ensureChild(pPrDefault, 'pPr');
        applySpacing(pPr);
      }

      // TableParagraph：表格单元格内段落常用样式（强制居中 + 间距/行距）
      const styles = Array.from(doc.getElementsByTagNameNS(W_NS, 'style'));
      styles.forEach(s=>{
        const type = getAttr(s,'type');
        const styleId = getAttr(s,'styleId');
        if(type === 'paragraph' && (styleId === 'TableParagraph')){
          const pPr = ensureChild(s,'pPr');
          applySpacing(pPr);
          applyCenter(pPr);
        }
      });

      return new XMLSerializer().serializeToString(doc);
    }

    function patchDocumentXml(documentXml){
      const W_NS = 'http://schemas.openxmlformats.org/wordprocessingml/2006/main';
      const parser = new DOMParser();
      const doc = parser.parseFromString(documentXml, 'application/xml');
      if(doc.getElementsByTagName('parsererror').length) return documentXml;

      const ensureChild = (parent, localName, insertFirst=false) => {
        const found = Array.from(parent.childNodes).find(n => n.nodeType===1 && n.namespaceURI===W_NS && n.localName===localName);
        if(found) return found;
        const el = doc.createElementNS(W_NS, 'w:' + localName);
        if(insertFirst && parent.firstChild){
          parent.insertBefore(el, parent.firstChild);
        }else{
          parent.appendChild(el);
        }
        return el;
      };

      const setSpacingAndCenter = (p) => {
        const pPr = ensureChild(p, 'pPr', true);
        const spacing = ensureChild(pPr, 'spacing');
        spacing.setAttributeNS(W_NS, 'w:before', '0');
        spacing.setAttributeNS(W_NS, 'w:after', '0');
        spacing.setAttributeNS(W_NS, 'w:line', '240');
        spacing.setAttributeNS(W_NS, 'w:lineRule', 'auto');

        const jc = ensureChild(pPr, 'jc');
        jc.setAttributeNS(W_NS, 'w:val', 'center');
      };

      // ✅ 只改表格内的段落（w:tbl 下所有 w:p）
      const tbls = Array.from(doc.getElementsByTagNameNS(W_NS, 'tbl'));
      tbls.forEach(tbl=>{
        const ps = Array.from(tbl.getElementsByTagNameNS(W_NS, 'p'));
        ps.forEach(setSpacingAndCenter);
      });

      return new XMLSerializer().serializeToString(doc);
    }

    async function patchDocxForTableParagraphs(blob){
      if(typeof JSZip === 'undefined') return blob; // 没加载到 JSZip 就不阻断导出

      const buf = await blob.arrayBuffer();
      const zip = await JSZip.loadAsync(buf);

      // 1) styles.xml（增强稳定性）
      const stylesFile = zip.file('word/styles.xml');
      if(stylesFile){
        const stylesXml = await stylesFile.async('string');
        zip.file('word/styles.xml', patchStylesXml(stylesXml));
      }

      // 2) document.xml（最终兜底：直接把表格内<w:p>全部改成 0/0 + 单倍 + 居中）
      const docFile = zip.file('word/document.xml');
      if(docFile){
        const docXml = await docFile.async('string');
        zip.file('word/document.xml', patchDocumentXml(docXml));
      }

      return await zip.generateAsync({type:'blob'});
    }

    // ========== 4) 导出 ==========
    async function saveAsDoc(){
      const bodyHtml = document.getElementById('output').innerHTML || '';
      const normalized = normalizeTablesForWord(bodyHtml);
      const html = buildDocHtml(normalized);

      const raw = htmlDocx.asBlob(html, {
        margins: {top: 720, right: 720, bottom: 720, left: 720},
        font: 'Times New Roman'
      });

      const patched = await patchDocxForTableParagraphs(raw);

      const now = new Date();
      const formattedDate = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
      saveAs(patched, `转换文件${formattedDate}.docx`);
    }

    // ========== 5) 事件绑定 ==========
    document.getElementById('btnConvert').addEventListener('click', convert);
    document.getElementById('btnSave').addEventListener('click', saveAsDoc);
    document.getElementById('input').addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.key === 'Enter') convert();
    });
  </script>
</body>
</html>
